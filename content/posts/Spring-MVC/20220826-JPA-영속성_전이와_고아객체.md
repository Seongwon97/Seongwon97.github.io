---
title: "[JPA] μμ†μ„± μ „μ΄μ™€ κ³ μ•„κ°μ²΄"
date: 2022-08-26
tags: ["SpringFramework", "JPA", "μμ†μ„± μ „μ΄", "CADCADE", "orphanRemoval"]
draft: false
---

> ν•΄λ‹Ή ν¬μ¤νΈλ” μΈν”„λ° κΉ€μν•λ‹μ [μλ°” ORM ν‘μ¤€ JPA ν”„λ΅κ·Έλλ° - κΈ°λ³ΈνΈ](https://www.inflearn.com/course/ORM-JPA-Basic/dashboard) κ°•μλ¥Ό κΈ°λ°μΌλ΅ μ‘μ„±ν•μ€μµλ‹λ‹¤.

# 1. μμ†μ„± μ „μ΄ (CASCADE)

## 1.1. μμ†μ„± μ „μ΄λ€?

μμ†μ„± μ „μ΄λ¥Ό μ•κΈ° μ•μ„ μ•„λμ μ½”λ“λ¥Ό λ¨Όμ € μ‚΄ν΄λ³΄κ² λ‹¤. 1:N κ΄€κ³„μΈ Teamκ³Ό Member κ°μ²΄κ°€ μ΅΄μ¬ν•λ‹¤. ν•΄λ‹Ή κ°μ²΄λ¥Ό μ΄μ©ν•μ—¬ 1κ°μ ν€κ³Ό ν•΄λ‹Ή ν€μ— μ°Έκ°€ν•λ” 2λ…μ λ©¤λ²„λ¥Ό λ§λ“¤μ–΄λ³΄κ² λ‹¤.

```java
@Entity
public class Team {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList<>();

    public void participate(Member member) {
        members.add(member);
        member.setTeam(this);
    }
}

@Entity
public class Member {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

```java
Member member1 = new Member();
member1.setName("Rex");

Member member2 = new Member();
member2.setName("μ„±μ›");

Team team = new Team();
team.setName("λ¨λ¨");
team.participate(member1);
team.participate(member2);

em.persist(team);
em.persist(member1);
em.persist(member2);
```

μ„μ μ½”λ“λ¥Ό λ³΄λ©΄ μ• μ μλ“―μ΄ 1κ°μ ν€κ³Ό 2λ…μ νμ›μ„ μμ†ν™”μ‹ν‚¤κΈ° μ„ν•΄μ„λ” `persist()` λ©”μ„λ“λ¥Ό 3λ² νΈμ¶ν•μ€λ‹¤. κ³Όμ—° persist()λ©”μ„λ“λ¥Ό 3λ²μ΄λ‚ νΈμ¶ν•λ” κ²ƒμ΄ μµμ„ μΌκΉ? memberλ” teamμ— μ†ν•΄μλ”λ° ν•λ²μ— μμ†ν™”λ¥Ό ν•  μλ” μ—†μ„κΉ? μ΄λ¥Ό ν•΄κ²°ν•΄μ£Όλ” κ²ƒμ΄ λ°”λ΅ μμ†μ„± μ „μ΄(CASCADE)μ΄λ‹¤.

μμ†μ„± μ „μ΄λ€ νΉμ • μ—”ν‹°ν‹°λ¥Ό μμ† μƒνƒλ΅ λ§λ“¤ λ• μ—°κ΄€λ μ—”ν‹°ν‹°λ„ ν•¨κΌ μμ† μƒνƒλ΅ λ³€κ²½ν•κ³  μ‹¶μ€ κ²½μ°μ— μ‚¬μ©ν•λ‹¤. μ¦‰, μ„μ μμ‹ μ½”λ“λ΅ μƒκ°μ„ ν•΄λ³΄λ©΄ Teamμ„ `persist()`ν•  λ•, Teamκ³Ό μ—°κ΄€μ΄ μλ” membersλ„ λ¨λ‘ μμ†ν™”λ¥Ό ν•΄μ¤€λ‹¤λ” λ»μ΄λ‹¤.

κ·Έλ ‡λ‹¤λ©΄ ν…μ¤νΈλ¥Ό μ„ν•΄ λ§¤ν•‘ μ–΄λ…Έν…μ΄μ…μ μ†μ„±μΈ cascade μµμ…μ„ μ„¤μ •ν•΄λ³΄κ² λ‹¤.

```java
@Entity
public class Team {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;

    @OneToMany(mappedBy = "team", cascade = CascadeType.ALL)
    private List<Member> members = new ArrayList<>();

    public void participate(Member member) {
        members.add(member);
        member.setTeam(this);
    }
}
```

Memberμ™€ Teamμ‚¬μ΄μ κ΄€κ³„μ—μ„ λ¶€λ¨μ μ—­ν• μ„ ν•λ” Teamμ—”ν‹°ν‹°μ μ—°κ΄€κ΄€κ³„ μ–΄λ…Έν…μ΄μ…μ— `CascaseType.ALL`μ„ μ¤¬λ‹¤. κ³Όμ—° μ•μ„ λ§ν• μ΄λ΅ λ€λ΅ teamλ§μ„ μμ†ν™”ν•μ€μ„ λ• memberλ“¤λ„ λ¨λ‘ μμ†ν™”λλ”μ§€ μ‚΄ν΄λ³΄κ² λ‹¤.

```java
Member member1 = new Member();
member1.setName("Rex");

Member member2 = new Member();
member2.setName("μ„±μ›");

Team team = new Team();
team.setName("λ¨λ¨");
team.participate(member1);
team.participate(member2);

em.persist(team);
```

κ²°κ³Όλ” μ•„λμ™€ κ°™μ΄ Teamλ§μ„ μμ†ν™”ν•μ€μμ—λ„ λ¶κµ¬ν•κ³  Teamκ³Ό μ—°κ΄€μ΄ μλ” Memberλ“¤λ„ λ¨λ‘ μμ†ν™”κ°€ λμ–΄ DBμ— μ €μ¥λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

![Untitled](image/20220826-JPA-μμ†μ„±_μ „μ΄μ™€_κ³ μ•„κ°μ²΄/img.png)

## 1.2. CASCADE μΆ…λ¥

- `CascadeType.ALL`Β : μ•„λμ λ¨λ“  μµμ…μ„ μ μ©ν•λ‹¤.
- `CascadeType.PERSIST`Β : ν•΄λ‹Ή μ—”ν‹°ν‹°μΒ `persist()`Β λ°μƒ μ‹ μ—°κ΄€λ μ—”ν‹°ν‹° λ¨λ‘ μ €μ¥(μμ†ν™”,Β `persist()`)ν•λ‹¤.
- `CascadeType.REMOVE`Β : ν•΄λ‹Ή μ—”ν‹°ν‹°μΒ `remove()`Β λ°μƒ μ‹ μ—°κ΄€λ μ—”ν‹°ν‹° λ¨λ‘ μ‚­μ (`remove()`)ν•λ‹¤.
- `CascadeType.MERGE`Β : ν•΄λ‹Ή μ—”ν‹°ν‹°μΒ `merge()`Β λ°μƒ μ‹ μ—°κ΄€λ μ—”ν‹°ν‹° λ¨λ‘ μμ •ν•κ±°λ‚ μ €μ¥(`merge()`)ν•λ‹¤.
- `CascadeType.REFRESH`Β : ν•΄λ‹Ή μ—”ν‹°ν‹°μΒ `refresh()`Β λ°μƒ μ‹ μ—°κ΄€λ μ—”ν‹°ν‹° λ¨λ‘ DBλ΅λ¶€ν„° λ‹¤μ‹ λ¶λ¬(`refresh()`)μ¨λ‹¤.
- `CascadeType.DETACH`Β : ν•΄λ‹Ή μ—”ν‹°ν‹°μΒ `detach()`Β λ°μƒ μ‹ μ—°κ΄€λ μ—”ν‹°ν‹° λ¨λ‘ μ¤€ μμ† μƒνƒ(μμ†μ„± μ»¨ν…μ¤νΈμ—μ„ μ‚­μ ,Β `detach()`)λ΅ λ°”κΎΌλ‹¤.

> CASCADE μ†μ„±μ μΆ…λ¥λ” μ„μ™€ κ°™μ΄ 6κ°μ μµμ…μ΄ μ κ³µλμ§€λ§ `ALL`, `PERSIST`, `REMOVE`κ°€ μ£Όλ΅ μ΄μ©λλ‹¤.
>

## 1.3. μ£Όμν•  μ  & Tip

- μμ†μ„± μ „μ΄λ” ν•λ‚μ λ¶€λ¨κ°€ μ—¬λ¬ μμ‹μ„ κ΄€λ¦¬ν•  λ• μλ―Έκ°€ μλ‹¤.
- μμ†μ„± μ „μ΄λ” μ—°κ΄€κ΄€κ³„ λ§¤ν•‘ μ–΄λ…Έν…μ΄μ…μ— μ„μΉν• μ†μ„±μ΄λΌ μ—°κ΄€κ΄€κ³„λ¥Ό λ§¤ν•‘ν•λ” κ²ƒκ³Ό κ΄€λ ¨μλ‹¤κ³  μƒκ°ν•  μ μλ‹¤. ν•μ§€λ§ μμ†μ„± μ „μ΄λ” μ—°κ΄€κ΄€κ³„λ¥Ό λ§¤ν•‘ν•λ” κ²ƒκ³Όλ” μ•„λ¬΄λ° κ΄€λ ¨μ΄ μ—†λ‹¤. μμ†μ„± μ „μ΄λ” μ—”ν‹°ν‹°λ¥Ό μμ†ν™”ν•  λ• μ—°κ΄€λ μ—”ν‹°ν‹°λ„ ν•¨κ» μμ†ν™”ν•λ” λ“±μ νΈλ¦¬ν•¨μ„ μ κ³µν• λΏμ΄λ‹¤.
- μμ†μ„± μ „μ΄λ” κ°μ²΄λ¥Ό μ—¬λ¬ κ³µκ°„μ—μ„ μ‚¬μ©ν•λ” κ²½μ°μ—λ” μ‚¬μ©ν•λ©΄ μ•λλ‹¤. μ—¬λ¬ κ³µκ°„μ—μ„ μ‚¬μ©ν•λ” κ°μ²΄μ— μμ†μ„± μ „μ΄λ¥Ό μ‚¬μ©ν•  κ²½μ°, ν•΄λ‹Ή λ°μ΄ν„°κ°€ μ™„μ „ν μ‚­μ λμ–΄ λ‹¤λ¥Έ μ„μΉμ—μ„λ„ λ”μ΄μƒ ν•΄λ‹Ή λ°μ΄ν„°λ¥Ό μ‚¬μ©ν•μ§€ λ»ν•λ” λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. κ·Έλμ„ μμ†μ„± μ „μ΄λ¥Ό μ‚¬μ©ν•λ ¤λ©΄ μμ‹ κ°μ²΄κ°€ λ¶€λ¨λ‘λ§ μ—°κ΄€μμ„ λ• μ‚¬μ©ν•΄μ•Όν•λ‹¤.
- μ‚¬μ©ν•  μ΅°κ±΄μ„ μ •λ¦¬ν•΄λ³΄λ©΄ λ‹¤μκ³Ό κ°™λ‹¤.
    1. Parentμ™€ Childμ life cycleμ΄ λ™μΌν•κ±°λ‚ λΉ„μ·ν•΄μ•Ό ν•λ‹¤.
    2. μμ‹ κ°μ²΄κ°€ λ¶€λ¨ μ™Έμ— μ—°κ΄€μ΄ μ—†λ” λ‹¨μΌ μ†μ μμΌλ• μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

# 2. κ³ μ•„κ°μ²΄

## 2.1. κ³ μ•„κ°μ²΄μ™€ orphanRemoval

κ³ μ•„κ°μ²΄λ” λ¶€λ¨μ™€μ μ—°κ΄€κ΄€κ³„κ°€ λμ–΄μ§„ μ—”ν‹°ν‹°λ¥Ό μλ―Έν•λ‹¤. μ—°κ΄€κ΄€κ³„ λ§¤ν•‘ μ–΄λ…Έν…μ΄μ…μ¤‘ `@OneToMany`μ™€ `@OneToOne`μ€  `orphanRemoval`μ΄λΌλ” μ†μ„±μ„ ν†µν•΄ κ³ μ•„κ°μ²΄λ¥Ό μλ™μΌλ΅ μ‚­μ μ‹μΌμ¤„ μ μλ‹¤. ν•΄λ‹Ή μµμ…μ„ trueλ΅ μ„¤μ •ν•μ—¬ κ³ μ•„κ°μ²΄λ¥Ό μλ™μΌλ΅ μ‚­μ ν•λ” μμ‹ μ½”λ“λ¥Ό ν•λ² λ³΄κ² λ‹¤.

```java
@Entity
public class Team {
    ...
    @OneToMany(mappedBy = "team", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Member> members = new ArrayList<>();
}

@Entity
public class Member {
    ...
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

μ•μ„ μμ†μ„± μ „μ΄μ—μ„ λ³΄μ•λ μ½”λ“μ—μ„ `@OneToMany`μ— `orphanRemoval = true` μµμ…μ„ ν™μ„±ν™” μ‹ν‚¨ ν›„μ— μ•„λμ μ½”λ“λ¥Ό μ‹¤ν–‰ν•΄λ³΄κ² λ‹¤.

```java
Member member = new Member();
member.setName("Rex");

Team team = new Team();
team.setName("λ¨λ¨");
team.participate(member);

em.persist(team);
em.persist(member);

em.flush();
em.clear();

Team findTeam = em.find(Team.class, team.getId());
findTeam.getMembers().remove(0);
```

μ‹¤ν–‰ μ½”λ“μƒμΌλ΅λ” team κ°μ²΄μ—μ„ memberμ λ¦¬μ¤νΈλ¥Ό κ°€μ Έμ¨ ν›„ 0λ² indexμ κ°’μ„ μ»¬λ ‰μ…μ—μ„ μ κ±°ν•λ©° μ—°κ΄€κ΄€κ³„λ§μ„ λμ–΄μ£Όμ—λ‹¤. μ—°κ²°μ΄ λκΈ΄ Memberκ°μ²΄λ” κ³ μ•„κ°μ²΄κ°€ λμ—μμΌλ΅ μ•„λμ™€ κ°™μ΄ Memberκ°μ²΄κ°€ μ‹¤μ λ΅ μ‚­μ λμ—λ‹¤.

![Untitled](image/20220826-JPA-μμ†μ„±_μ „μ΄μ™€_κ³ μ•„κ°μ²΄/img_1.png)

> π“Β  μμ‹μ™€ κ°™μ΄ `orphanRemoval = true` μ„ ν™μ„±ν™”μ‹ν‚¤κ³  μ»¬λ ‰μ… μƒμ—μ„ μ—°κ²°μ„ λμ–΄μ£Όμ—μ„ λ• κ³ μ•„κ°μ²΄κ°€ μ‚­μ λκ² ν•λ ¤λ©΄ `cascade = CascadeType.PERSIST`λ¥Ό ν™μ„±ν™”μ‹μΌμ¤μ•Ό ν•λ‹¤. μμ†μ„± μ „μ΄λ¥Ό ν™μ„±ν™”μ‹ν‚¤μ§€ μ•κ³  `orphanRemoval = true` λ§μ„ μ„¤μ •ν•λ‹¤λ©΄ Teamκ°μ²΄λ¥Ό μ‚­μ ν•  λ•λ§ κ³ μ•„κ°μ²΄κ°€ μ κ±°λκ³  μ„μ μμ‹μ™€ κ°™μ΄ μ»¬λ ‰μ…μ—μ„ μ κ±°ν•μ€μ„ λ•λ” κ³ μ•„κ°μ²΄κ°€ μ κ±°λμ§€ μ•λ”λ‹¤.
>

## 2.2. orphanRemoval μµμ…μ€ μ–Έμ  μ‚¬μ©ν•΄μ•Ό ν• κΉ?

`orphanRemoval = true` λ„ μμ†μ„± μ „μ΄μ™€ λ™μΌν•κ² λΌμ΄ν”„ μ‚¬μ΄ν΄μ΄ λ™μΌν•κ³  μ—”ν‹°ν‹°κ°€ μ‚¬μ©λλ” κ³³μ΄ λ³ΈμΈ ν•λ‚μΌ λ•λ§ μ‚¬μ©ν•μ—¬μ•Ό ν•λ‹¤.

## 2.3. Cascade.REMOVEμ™€ orphanRemoval = true μ°¨μ΄

`Cascade.REMOVE`μ™€ `orphanRemoval=true`λ” κ°λ…μ μΌλ΅λ§ λ΄¤μ„ λ• μ°¨μ΄λ¥Ό κµ¬λ¶„ν•μ§€ λ»ν•κ³  ν—·κ°λ¦΄ μ μλ‹¤. ν•μ§€λ§ λ‘μ€ λ―Έλ¬ν•κ² λ‹¤λ¥Έ μ μ΄ μλ‹¤.

`Cascade.REMOVE`μ€ λ¶€λ¨ μ—”ν‹°ν‹°κ°€ μ‚­μ λμ—μ„ λ• μ—°κ΄€λ μμ‹ μ—”ν‹°ν‹°λ“¤μ„ λ¨λ‘ μ‚­μ μ‹ν‚¤λ” μµμ…μ΄λ‹¤. ν•μ§€λ§ λ¶€λ¨ μ—”ν‹°ν‹°λ¥Ό μ‚­μ ν•μ€μ„ λ•λ§ μ—°μ†μ„± μ „μ΄κ°€ λ°λ™ν•κ² λκ³  λ¶€λ¨ μ—”ν‹°ν‹°μ—μ„ `findTeam.getMembers().remove(0);` μ™€ κ°™μ΄ μμ‹ μ—”ν‹°ν‹°λ¥Ό μ»¬λ ‰μ… ν•„λ“μ—μ„ μ κ±°ν•μ€μ„ λ•λ” μ•„λ¬΄λ° λ³€ν™”κ°€ λ°μƒν•μ§€ μ•λ”λ‹¤.

λ°λ©΄μ— `orphanRemoval = true`μ€ λ¶€λ¨ μ—”ν‹°ν‹°κ°€ μ κ±°λμ—μ„ λ•μ™€ μμ‹ μ—”ν‹°ν‹°λ¥Ό λ¶€λ¨μ μ»¬λ ‰μ… ν•„λ“μ—μ„ μ κ±°ν•μ€μ„ λ•λ„ κ³ μ•„κ°μ²΄κ°€ λμ–΄ ν•΄λ‹Ή μ—”ν‹°ν‹°λ” μ‚­μ κ°€ λλ‹¤.

## 2.4. Cascade.ALL + orphanRemoval = true

`Cascade.ALL`μ™€ `orphanRemoval = true` μµμ…μ„ λ¨λ‘ ν™μ„±ν™”μ‹ν‚¤λ©΄ λ¶€λ¨ μ—”ν‹°ν‹°λ¥Ό ν†µν•΄μ„ μμ‹μ μƒλ…μ£ΌκΈ°λ¥Ό κ΄€λ¦¬ν•  μ μλ‹¤. μ¦‰, μμ‹ μ—”ν‹°ν‹°λ“¤μ€ λ¶€λ¨ μ—”ν‹°ν‹°λ¥Ό λ”°λΌ λΌμ΄ν”„ μ‚¬μ΄ν΄μ„ ν•¨κ»ν•λ©° μμ†ν™”, μ κ±°κ°€ λκ² λλ‹¤.

μ΄λ” λ„λ©”μΈ μ£Όλ„ μ„¤κ³„(DDD)μ Aggregate Root κ°λ…μ„ κµ¬ν„ν•  λ• μ μ©ν•λ‹¤.

# π“ Reference
- [μλ°” ORM ν‘μ¤€ JPA ν”„λ΅κ·Έλλ° - κΈ°λ³ΈνΈ - μΈν”„λ° | κ°•μ](https://www.inflearn.com/course/ORM-JPA-Basic/dashboard)
- [μ•κ³  μ“°λ” Cascade(μμ†μ„± μ „μ΄)](https://hongchangsub.com/jpa-cascade-2/)
- [DDD, Aggregate Root λ€?](https://eocoding.tistory.com/36)
