---
title: "Redisë¥¼ í†µí•œ ë¶„ì‚°ë½(Distribution Lock)ìœ¼ë¡œ ë™ì‹œì„± ë¬¸ì œ ì œì–´í•˜ê¸°"
date: 2023-05-03
tags: ["MSA", "ë¶„ì‚°ë½", "Distribution Lock", "Redis", "Lettuceë¥¼", "Redisson"]
draft: false
---

# ë¶„ì‚°ë½(Distribution Lock)ì´ë€?

> ë¶„ì‚°ë½ì€ **ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ìŠ¤ë ˆë“œê°€ ê³µìœ í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ê¸° ìœ„í•œ ë©”ì»¤ë‹ˆì¦˜**ì…ë‹ˆë‹¤.
>

[ë¹„ê´€ì ë½/ë‚™ê´€ì ë½ ê²Œì‹œê¸€](https://seongwon.dev/Spring-MVC/20230430-%EB%B9%84%EA%B4%80%EC%A0%81%EB%9D%BD%EA%B3%BC_%EB%82%99%EA%B4%80%EC%A0%81%EB%9D%BD/)ì—ì„œ ë‹¤ë£¨ì—ˆë“¯ì´ ì„œë¹„ìŠ¤ ê°œë°œì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ ì¤‘ìš”í•œ ë¬¸ì œì´ë‹¤. ë™ì‹œì„±ë¬¸ì œëŠ” ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ì“°ë ˆë“œê°€ ë™ì¼í•œ ìì›ì„ ì ‘ê·¼í•˜ë©° ê²½ìŸ(Race Condition)í•˜ëŠ” ìƒí™©ì„ ëœ»í•œë‹¤. ì´ëŠ” **ë‘ ë²ˆì˜ ê°±ì‹  ë¬¸ì œ** ë“± ìš°ë¦¬ì˜ ê³„íšê³¼ëŠ” ë‹¤ë¥¸ ë™ì‘ì„ ìœ ë°œí•  ìˆ˜ ìˆë‹¤.

ìš´ì˜ì²´ì œë¥¼ í•™ìŠµí•˜ë©° ë°°ì› ë“¯ì´ ê²½ìŸ ìƒí™©(Race Condition)ì„ í•´ê²°í•˜ëŠ” ë°©ë²•ìœ¼ë¡œëŠ” ì„ê³„ êµ¬ì—­(Critical Section)ì—ëŠ” í•œ ê°œì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼í•˜ë„ë¡ í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•œë‹¤. ìë°”ì—ì„œëŠ” ì•„ë˜ì˜ ì½”ë“œì™€ ê°™ì´ `synchronized`ë¥¼ í†µí•´ í•œ ë²ˆì— í•œ ê°œì˜ ìŠ¤ë ˆë“œë§Œì´ íŠ¹ì • ë©”ì„œë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•œë‹¤.

```java
public synchronized ParticipantResponse participate1(Long partyId, String name) {
    Party party = partyRepository.findById(partyId).orElseThrow();
    if (party.isFull()) {
        throw new IllegalArgumentException("ì •ì›ì´ ê°€ë“ ì°¨ìˆìŠµë‹ˆë‹¤.");
    }

    Participant participant = participantRepository.save(new Participant(name, party));
    return new ParticipantResponse(participant.getId(), participant.getName());
}
```

í•˜ì§€ë§Œ í•´ë‹¹ ë°©ë²•ì€ ë‹¨ì¼ ì„œë²„ì—ì„œëŠ” í•´ê²°ë²•ì´ ë  ìˆ˜ ìˆìœ¼ë‚˜, Nê°œì˜ ì„œë²„ë¥¼ ìš´ì˜í•˜ëŠ” ë¶„ì‚° í™˜ê²½ì—ì„œëŠ” ê°ê°ì˜ ì„œë²„ì—ì„œ 1ê°œì˜ ìš”ì²­ì”© ë™ì‘ì‹œí‚¨ë‹¤ í•˜ë”ë¼ë„ ì „ì²´ì ì¸ ì‹œìŠ¤í…œì„ ë³´ë©´ Nê°œì˜ ë™ì¼ ìš”ì²­ì´ ì‹¤í–‰ë˜ì–´ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ì§€ ëª»í•˜ê²Œ ëœë‹¤. ë¶„ì‚°ë½ì€ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•´ì¤€ë‹¤.

ë¶„ì‚°ë½ì€ ë½ì— ëŒ€í•œ ì •ë³´ë¥¼ Redis, Zookeper, MySQL ë“±ì˜ ì™¸ë¶€ ì €ì¥ì†Œì— ì €ì¥ì„ í•˜ê³  ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” **ì„ê³„ êµ¬ì—­(Critical Section)ì— ì ‘ê·¼ì„ í•  ë•Œ ë½ì„ ì·¨ë“í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸**í•˜ë©° íšë“í•  ìˆ˜ ìˆë‹¤ë©´ ì ‘ê·¼í•˜ê²Œ ëœë‹¤.

![Untitled](image/20230503-Redisë¥¼_í†µí•œ_ë¶„ì‚°ë½ìœ¼ë¡œ_ë™ì‹œì„±_ë¬¸ì œ_ì œì–´í•˜ê¸°/img.png)

ì¦‰, ì„ê³„ êµ¬ì—­(Critical Section)ì˜ Entry Sectionì—ì„œ ë½ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°–ëŠ” ì €ì¥ì†Œì— ë½ì„ ì–»ì„ ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ì—¬ë¶€ë¥¼ ë¬»ê³  ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤ë©´ ë½ì„ ì–»ê³  ì„ê³„ êµ¬ì—­ì— ì ‘ê·¼í•˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  ì‘ì—…ì´ ëë‚¬ìœ¼ë©´ Exit Sectionì—ì„œ ë½ì„ í’€ì–´ ì´í›„ì— ë‹¤ë¥¸ ìš”ì²­ë“¤ì´ ì„ê³„ êµ¬ì—­ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

# ë¶„ì‚° ë½ vs ë‚™ê´€ì  ë½/ë¹„ê´€ì  ë½

ë¶„ì‚° ë½ì„ ì²˜ìŒ í•™ìŠµí•˜ë©° ë‚™ê´€ì  ë½/ë¹„ê´€ì  ë½ìœ¼ë¡œë„ ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê±°ë¼ëŠ” ìƒê°ì´ ë“¤ì–´ ë¶„ì‚° ë½ì´ í•„ìš”í•œ ì´ìœ ë¥¼ ì´í•´í•˜ì§€ ëª» í–ˆë‹¤. ê·¸ ì´ìœ ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

- ë¶„ì‚° ì„œë²„ë¥¼ êµ¬ì¶•í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ì¤‘í™”ê¹Œì§€ í•˜ë”ë¼ë„ ë°ì´í„°ë² ì´ìŠ¤ëŠ” ë³´í†µ 1ê°œì˜ Write DBì™€ Nê°œì˜ Read DBë¥¼ ë‘ê¸°ì— ì—¬ëŸ¬ ë¶„ì‚° ì„œë²„ì—ì„œì˜ ì“°ê¸° ìš”ì²­ì€ ê²°êµ­ 1ê°œì˜ Write DBë¡œ ëª°ë¦¬ê²Œ ëœë‹¤.
    - ë‚™ê´€ì  ë½ì„ ê±¸ì–´ë‘˜ ê²½ìš°, ê°ê°ì˜ ì„œë²„ì—ì„œëŠ” ë¨¼ì € ë³€ê²½ëœ ë°ì´í„°ê°€ ìˆì–´ ë°ì´í„°ì˜ Versionì´ ì—…ë°ì´íŠ¸ë˜ë©´ ìš”ì²­ ì‹¤íŒ¨ ë° ì¬ì‹œë„ë¥¼ í•˜ê²Œ ëœë‹¤.
    - ë¹„ê´€ì  ë½ì„ ê±¸ì–´ë‘˜ ê²½ìš°, Nê°œì˜ ì„œë²„ì—ì„œ ë™ì‹œ ìš”ì²­ì„ ë³´ë‚´ë”ë¼ë„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ `SELECT FOR UPDATE`ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì½ìœ¼ë©´ì„œ x-lockì„ ê±¸ì–´ë‘ë©´ 1ê°œì˜ ì„œë²„ì˜ 1ê°œì˜ ìŠ¤ë ˆë“œì—ì„œë§Œ ë°ì´í„° ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.

í•˜ì§€ë§Œ ì—­ì‹œë‚˜ ë¶„ì‚° ë½ì€ ì´ìœ  ì—†ì´ ë§Œë“¤ì–´ì§„ ê²ƒì´ ì•„ë‹ˆì—ˆë‹¤. ì´ìœ ëŠ” ì¼ì „ì— ì§„í–‰í•œ ëª¨ì„ í”Œë«í¼ì¸ [ëª¨ë‘ ëª¨ì—¬ë¼ í”„ë¡œì íŠ¸](https://github.com/woowacourse-teams/2022-momo)ì˜ ì˜ëª»ëœ êµ¬í˜„ì„ ì˜ˆì‹œë¡œ ì„¤ëª…í•˜ê² ë‹¤. ëª¨ë‘ ëª¨ì—¬ë¼ í”„ë¡œì íŠ¸ì—ì„œëŠ” ëª¨ì„ ì°¸ì—¬ ê¸°ëŠ¥ì—ì„œ ë™ì‹œ ìš”ì²­ì´ ë°œìƒí•˜ë©´ ì œí•œëœ ì¸ì› ì´ìƒì˜ ì°¸ì—¬ìê°€ ë°œìƒí•˜ëŠ” ë™ì‹œì„± ë¬¸ì œê°€ ì¡´ì¬í–ˆë‹¤. ìš°ë¦¬ íŒ€ì€ ìœ„ì˜ ì´ìœ ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì‚° í™˜ê²½ì—ì„œ ë°œìƒí•œ í•´ë‹¹ ë¬¸ì œë¥¼ ë¹„ê´€ì  ë½ìœ¼ë¡œ í•´ê²°í•˜ì˜€ë‹¤.

> ğŸ“ŒÂ ë‚™ê´€ì  ë½ê³¼ ë¹„ê´€ì  ë½ ì¤‘ì—ì„œ ë¹„ê´€ì  ë½ì„ ì„ íƒí•œ ì´ìœ ëŠ” ì„ ì°©ìˆœ ì„œë¹„ìŠ¤ì˜ ê²½ìš°, ì¶©ëŒì— ëŒ€í•œ ì¦ì€ ë¡¤ë°± ì²˜ë¦¬ë¡œ ì¸í•´ ì„±ëŠ¥ì´ ë” ì•ˆ ì¢‹ì•„ì§ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ì—ˆë‹¤.
>
> - e.g. 10ëª…ë§Œ ì°¸ì—¬ ê°€ëŠ¥í•œ ëª¨ì„ ì„œë¹„ìŠ¤ì— ë‚™ê´€ì  ë½ì´ ê±¸ë ¤ìˆê³  1000ëª…ì´ ë™ì‹œ ìš”ì²­ì„ í•˜ì˜€ë‹¤ ê°€ì •í•˜ì. ê·¸ëŸ¬ë©´ ìµœì´ˆ ì»¤ë°‹ 1ëª…ì€ í†µê³¼í•˜ë©° ë²„ì „ì„ ë³€ê²½í•˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  ì´í›„ì˜ ë‚¨ì€ 999ëª…ì€ ì—…ë°ì´íŠ¸ ì‹œì ì— ë²„ì „ì´ ë³€ê²½ë˜ì—ˆê¸°ì— ì·¨ì†Œë˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì˜¤ë¥˜ ì²˜ë¦¬ ë¡œì§ì— ë”°ë¼ ë‹¤ì‹œ ì¬ì‹œë„ë¥¼ ìš”ì²­í•´ì•¼í•œë‹¤. ê·¸ë¦¬ê³  ë‹¤ìŒ í•œëª…ì´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê²Œë˜ê³  ë‚¨ì€ 998ëª…ì€ ë‹¤ì‹œ ìƒˆë¡œìš´ ë²„ì „ì„ ì½ê³  ì¬ì‹œë„ë¥¼ í•´ì•¼í•œë‹¤â€¦(ë°˜ë³µ)

ë¹„ê´€ì  ë½ì„ í†µí•´ ë™ì‹œì„± ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ìˆì—ˆìœ¼ë‚˜ ì°¸ì—¬ ê¸°ëŠ¥ê³¼ ë¬´ê´€í•œ ì¡°íšŒ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ë‹¤. ìƒí™© ì´í•´ë¥¼ ìœ„í•´ ì°¸ì—¬í•˜ê¸° ë¡œì§ì„ ì‚´í´ë³´ê² ë‹¤.

![Untitled](image/20230503-Redisë¥¼_í†µí•œ_ë¶„ì‚°ë½ìœ¼ë¡œ_ë™ì‹œì„±_ë¬¸ì œ_ì œì–´í•˜ê¸°/img_1.png)

```java
@RequiredArgsConstructor
@Transactional(readOnly = true)
@Service
public class ParticipateService {

    private final MemberFindService memberFindService;
    private final GroupFindService groupFindService;

    @Transactional
    public void participate(Long groupId, Long memberId) {
        // findByIdForUpdate -> SELECT FOR UPDATEë¥¼ í†µí•œ x-lock íšë“
        Group group = groupFindService.findByIdForUpdate(groupId);
        Member member = memberFindService.findMember(memberId);

        // group ê°ì²´ëŠ” capacityì™€ ì°¸ì—¬ìì˜ ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•œ ê·¸ë˜í”„ íƒìƒ‰ì„ í•˜ê¸° ìœ„í•´ íšë“
        // group í…Œì´ë¸”ì—ëŠ” ë³€ê²½ X, Participants í…Œì´ë¸”ì—ë§Œ ìƒˆë¡œìš´ ì°¸ê°€ì ë°ì´í„°ê°€ ì¶”ê°€ë¨
        group.participate(member);
    }
}
```

ìœ„ì˜ ë¡œì§ì„ ì‚´í´ë³´ë©´ `participate()` ë©”ì„œë“œê°€ ì‹¤í–‰ë¨ê³¼ ë™ì‹œì— `SELECT FOR UPDATE`ë¥¼ í†µí•´ Groupì •ë³´ë¥¼ ì–»ìœ¼ë©° í•´ë‹¹ ë°ì´í„°ì— x-lockì„ ê±¸ë©° ë‹¤ë¥¸ ì½ê¸°, ì“°ê¸° ìš”ì²­ì— ëŒ€í•œ ëª¨ë“  ì ‘ê·¼ì„ ë¶ˆê°€í•˜ê²Œ í•œë‹¤. ì¦‰, ëª¨ì„ ì°¸ì—¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ëª¨ì„ í…Œì´ë¸”ì— ë³€ë™ì„ ì£¼ì§€ ì•ŠìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ëª¨ì„ ì¡°íšŒì— ëŒ€í•œ ì ‘ê·¼ë„ ë§‰ê²Œ ë˜ë©° ì¡°íšŒ ì„±ëŠ¥ì—ë„ ì˜í–¥ì„ ì£¼ê²Œ ë˜ì—ˆë‹¤. ë¶„ì‚°ë½ì€ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•´ì¤„ ìˆ˜ ìˆë‹¤. ì´í›„ ë¡œì§ìœ¼ë¡œ ì‚´í´ë³´ê² ì§€ë§Œ ê°„ë‹¨íˆ ì„¤ëª…í•˜ìë©´ ê¸°ì¡´ ì½”ë“œì²˜ëŸ¼ ë°ì´í„°ë² ì´ìŠ¤ rowì— Lockì„ ê±°ëŠ” ê²ƒì´ ì•„ë‹Œ ì§ì ‘ì ìœ¼ë¡œ ì°¸ì—¬í•˜ê¸° ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ” ë¶€ë¶„(Critical Section)ì— ê±¸ë©° ëª¨ì„ í…Œì´ë¸”ì˜ ì¡°íšŒì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

ë¬¸ì œë“¤ì„ ê²ªìœ¼ë©° í˜„ì¬ ë‚´ê°€ ë‚´ë¦° ê²°ë¡ ì€ ì•„ë˜ì™€ ê°™ë‹¤.

- í•œ ê°œì˜ í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ë³€ê²½í•˜ëŠ” ë™ì‹œì„± ë¬¸ì œëŠ” ë‚™ê´€ì  ë½/ë¹„ê´€ì  ë½ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
- ìœ„ì˜ ìƒí™©ê³¼ ê°™ì´ 1:Nì˜ ê´€ê³„ì˜ ë‘ í…Œì´ë¸”ì—ì„œ 1ì˜ ë°ì´í„°ì— ë³€ë™ ì—†ì´ Nì˜ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë ¤ëŠ” ìƒí™©ì—ì„œëŠ” ë¶„ì‚°ë½ì´ ì í•©í•˜ë‹¤.

> í•´ë‹¹ ê²°ë¡ ì€ ì£¼ë‹ˆì–´ ê°œë°œì ì…ì¥ì—ì„œ ì ì€ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ìƒê°í•œ ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ì ì€ ì°¸ê³ ë¶€íƒë“œë¦½ë‹ˆë‹¤!!
>

ì´ì œ ë¶„ì‚°ë½ì— ëŒ€í•œ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê² ë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¨¼ì € ë™ì‹œì„± ë¬¸ì œ ìƒí™©ì„ ê°€ì •í•˜ê³  ì´í›„ Redisë¥¼ í†µí•œ ë‘ ê°€ì§€ ë°©ë²•ì˜ ë¶„ì‚°ë½ì„ êµ¬í˜„í•´ë³´ê³ ì í•œë‹¤.

# ë™ì‹œì„± ë¬¸ì œ ìƒí™© ê°€ì •

ë¬¸ì œëŠ” ì•ì„œ ì‚´í´ë³¸ ì¸ì› ì œí•œì´ ìˆëŠ” ëª¨ì„ì— ì°¸ì—¬ ìš”ì²­ì´ ë™ì‹œì— ìš”ì²­ì´ ì˜¤ë©° ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ ì‚´í´ë³´ë ¤ í•œë‹¤. ë¨¼ì € ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ê² ë‹¤.

> ì•ì„  í”„ë¡œì íŠ¸ ì˜ˆì‹œ ì½”ë“œì—ì„œëŠ” ëª¨ì„ ì´ë¦„ìœ¼ë¡œ Groupì´ë¼ëŠ” ì´ë¦„ì„ ì‚¬ìš©í–ˆëŠ”ë°, ì´í›„ ì˜ˆì‹œ ì½”ë“œì—ì„œëŠ” Partyë¼ëŠ” ì´ë¦„ì„ ì‚¬ìš©í•œ ì ì€ ì–‘í•´ë¶€íƒë“œë¦½ë‹ˆë‹¤.
>

**Party, PartyRepository**

```java
@Entity
@Getter
@NoArgsConstructor
public class Party {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private int capacity;

    @OneToMany(mappedBy = "party")
    private final List<Participant> participants = new ArrayList<>();

    public Party(String name, int capacity) {
        this.name = name;
        this.capacity = capacity;
    }

    public boolean isFull() {
        return participants.size() >= capacity;
    }
}

public interface PartyRepository extends JpaRepository<Party, Long> {}
```

**Participant, ParticipantRepository**

```java
@Entity
@Getter
@NoArgsConstructor
public class Participant {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "partyId")
    private Party party;

    public Participant(String name, Party party) {
        this.name = name;
        this.party = party;
    }
}

public interface ParticipantRepository extends JpaRepository<Participant, Long> {}
```

**PartyService**

```java
@Service
@RequiredArgsConstructor
public class PartyService {

    private final PartyRepository partyRepository;
    private final ParticipantRepository participantRepository;

    @Transactional
    public PartyResponse create(String partyName, int capacity) {
        Party party = partyRepository.save(new Party(partyName, capacity));
        return new PartyResponse(party.getId(), party.getName(), party.getCapacity());
    }

    @Transactional
    public ParticipantResponse participate(Long partyId, String name) {
        Party party = partyRepository.findById(partyId).orElseThrow();
        if (party.isFull()) {
            throw new IllegalArgumentException("ì •ì›ì´ ê°€ë“ ì°¨ìˆìŠµë‹ˆë‹¤.");
        }

        Participant participant = participantRepository.save(new Participant(name, party));
        return new ParticipantResponse(participant.getId(), participant.getName());
    }
}
```

**PartyController**

```java
@RestController
@RequestMapping("/parties")
@RequiredArgsConstructor
public class PartyController {

    private final PartyService partyService;

    @PostMapping
    public ResponseEntity<PartyResponse> create(@RequestBody PartyRequest request) {
        PartyResponse response = partyService.create(request.getName(), request.getCapacity());

        return ResponseEntity.ok(response);
    }

    @PostMapping("/{partyId}")
    public ResponseEntity<ParticipantResponse> participate(@PathVariable Long partyId,
                                                           @RequestBody ParticipateRequest request) {
        ParticipantResponse response = partyService.participate(partyId, request.getName());

        return ResponseEntity.ok(response);
    }
}
```

ì½”ë“œëŠ” ê°„ë‹¨í•˜ë‹¤. ëª¨ì„(Party)ì™€ ì°¸ì—¬ì(Participant)ì—”í‹°í‹°ëŠ” 1:Nì˜ ê´€ê³„ë¥¼ ê°–ëŠ”ë‹¤. ê·¸ë¦¬ê³  ëª¨ì„ ì°¸ì—¬ ìš”ì²­ì´ ì˜¤ë©´ ëª¨ì„ì— ì°¸ì—¬í•œ ì‚¬ìš©ì ìˆ˜ì™€ ëª¨ì„ì˜ ì •ì›(capacity)ë¥¼ ë¹„êµí•˜ì—¬ ì°¸ì—¬í•  ìˆ˜ ìˆìœ¼ë©´ ì°¸ì—¬í•˜ê³  ì°¸ì—¬ê°€ ë¶ˆê°€ëŠ¥í•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

ìœ„ì˜ ì½”ë“œë¥¼ **8080, 9090í¬íŠ¸ì— ê°ê° ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰**ì‹œí‚¤ê³  ì°¸ì—¬ìê°€ 8ëª…ì´ ì •ì›ì¸ ëª¨ì„(party)ì— **JMeterë¥¼ í†µí•´ ê°ê° ì„œë²„ë‹¹ 100ëª…ì”© ì´ 200ê°œëª…ì˜ ìœ ì €ê°€ ë™ì‹œì— ëª¨ì„ ì°¸ì—¬ ìš”ì²­**ì„ í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ëŒë ¤ë´¤ë‹¤. ê·¸ ê²°ê³¼ ì •ì›ì„ ë„˜ì–´ì„  11ëª…ì´ ëª¨ì„ì— ì°¸ì—¬í•˜ëŠ” ê²°ê³¼ë¥¼ ì–»ê²Œ ë˜ì—ˆë‹¤.

![Untitled](image/20230503-Redisë¥¼_í†µí•œ_ë¶„ì‚°ë½ìœ¼ë¡œ_ë™ì‹œì„±_ë¬¸ì œ_ì œì–´í•˜ê¸°/img_2.png)

# Redisë¥¼ í†µí•œ ë¶„ì‚° ë½ êµ¬í˜„

Redis Clientë¡œ ë¶„ì‚°ë½ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ìœ¼ë¡œëŠ” Lettuceë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ê³¼ Redissonì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•œë‹¤.

## ë°©ë²•1. Lettuceë¥¼ í†µí•œ ìŠ¤í•€ë½

ì²« ë²ˆì§¸ ë°©ë²•ì€ ë ˆë””ìŠ¤ í´ë¼ì´ì–¸íŠ¸ì¸ [Lettuce](https://github.com/lettuce-io/lettuce-core)ë¥¼ í†µí•´ ìŠ¤í•€ ë½ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì´ë‹¤.

> ğŸ“ŒÂ ìŠ¤í•€ ë½ (Spin Lock)ì´ë€?
>
> - ë½ì„ ê±¸ì§€ ëª»í•˜ë©´ ë¬´í•œë£¨í”„ë¥¼ ëŒë©° ë½ì„ ì–»ìœ¼ë ¤ê³  ì‹œë„í•˜ëŠ” ë™ê¸°í™” ê¸°ë²•ì´ë‹¤
> - ë½ì„ ì–»ì„ë•Œê¹Œì§€ ê³„ì† ìš”ì²­ì„ ë³´ë‚´ë©° ëŒ€ê¸°í•˜ì—¬ ì„œë²„ì— ë¶€í•˜ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤.

Redisì˜ â€œê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì„¸íŒ…í•œë‹¤â€ë¼ëŠ” `SETNX` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ ë ˆë””ìŠ¤ì— íŠ¹ì • ë°ì´í„°ì— ë½ì„ ê±¸ì—ˆë‹¤ëŠ” ì„¸íŒ… ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì„¸íŒ…í•˜ê³ , ì„¸íŒ… ì—¬ë¶€ë¥¼ ë¦¬í„´ ê°’ìœ¼ë¡œ ë°›ì•„ íšë“ì„ í•œë‹¤. ì¦‰, ì§€ì†ì ìœ¼ë¡œ ë½ì„ íšë“í•  ìˆ˜ ìˆëŠ”ì§€ Redis ì„œë²„ì— ë¬¼ì–´ë³´ë©° ì„ê³„ êµ¬ì—­ì— ì ‘ê·¼ ê°€ëŠ¥í•  ë•Œ ì§„ì…í•˜ê²Œ ë˜ëŠ” ë°©ë²•ì´ë‹¤.

ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ê² ë‹¤.

### ì˜ì¡´ì„± ì¶”ê°€

```java
implementation 'org.springframework.boot:spring-boot-starter-cache'
```

### ì½”ë“œ ì‘ì„±

**RedisLockRepository**

```java
@Component
@RequiredArgsConstructor
public class RedisLockRepository {

    private final RedisTemplate<String, String> redisTemplate;

    // setIfAbsent() ë¥¼ í™œìš©í•´ì„œ SETNXë¥¼ ì‹¤í–‰í•œë‹¤.
    // keyëŠ” Partyí…Œì´ë¸”ì˜ PKì´ë©° Valueë¥¼ "lock" ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
    public Boolean lock(long key) {
        return redisTemplate
                .opsForValue()
                .setIfAbsent(String.valueOf(key), "lock", Duration.ofMillis(3_000));
    }

    public Boolean unlock(long key) {
        return redisTemplate.delete(String.valueOf(key));
    }
}
```

RedisLockRepositoryëŠ” `RedisTemplate`ë¥¼ í†µí•´ ì„œë²„ì— `SETNX` ëª…ë ¹ì–´ë¥¼ ìš”ì²­í•˜ë©° ë½ì„ íšë“í•˜ëŠ” ë¡œì§ê³¼ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ë©° ë½ì„ í‘¸ëŠ” ë¡œì§ì„ ì‘ì„±í•œë‹¤.

**PartyService**

ì„œë¹„ìŠ¤ ë¡œì§ì—ëŠ” ê¸°ì¡´ì— ì°¸ì—¬ìë¥¼ ì €ì¥í•˜ë˜ ë¡œì§ì„ ìˆ˜í–‰í•˜ê¸° ì „ì— ë½ì„ íšë“í•˜ëŠ” ë¡œì§ì´ ì¶”ê°€ë˜ì—ˆë‹¤. `while`ë¬¸ì„ í†µí•´ ìŠ¤í•€ ë½ì„ êµ¬í˜„í•˜ë©° ë½ì„ íšë“í•  ë•Œê¹Œì§€ ê³„ì† ìš”ì²­ì„ ìˆ˜í–‰í•˜ê³  ë½ì„ íšë“í•˜ê²Œ ëœ ì´í›„ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ëª¨ë“  ì‘ì—…ì´ ìˆ˜í–‰ëœ ì´í›„ì—ëŠ” `finally`ë¬¸ì„ í†µí•´ ë½ì„ í•´ì œí•˜ê²Œ ëœë‹¤.

ì´ì œ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•œ ìƒí™©ê³¼ ë™ì¼í•˜ê²Œ 2ê°œì˜ ì„œë²„ì— ê°ê° 100ê°œì˜ ìš”ì²­ì„ ë³´ë‚´ë©° ë™ì‹œì„± ìƒí™©ì„ ë§Œë“¤ì–´ë³´ê² ë‹¤.

![Untitled](image/20230503-Redisë¥¼_í†µí•œ_ë¶„ì‚°ë½ìœ¼ë¡œ_ë™ì‹œì„±_ë¬¸ì œ_ì œì–´í•˜ê¸°/img_3.png)

ê²°ê³¼ëŠ” 8ëª… ì •ì›ì¸ ëª¨ì„ì— 8ê°œì˜ ì°¸ì—¬ì ë°ì´í„°ë§Œ ì¶”ê°€ë˜ì–´ ì„±ê³µì ì´ì—ˆë‹¤. í•˜ì§€ë§Œ Lettuceë¥¼ í†µí•œ ë¶„ì‚° ë½ êµ¬í˜„ì€ ëª‡ê°€ì§€ ë¬¸ì œì ì´ ì¡´ì¬í•œë‹¤.

### ë¬¸ì œì 

1. Lockì˜ íƒ€ì„ì•„ì›ƒì´ ì§€ì •ë˜ì–´ìˆì§€ ì•Šë‹¤.

   ë§Œì•½ íŠ¹ì • ìŠ¤ë ˆë“œê°€ Lockì„ ì–»ê³  ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•´ Lockì„ í•´ì œí•˜ì§€ ëª»í•˜ëŠ” ìƒí™©ì´ ë°œìƒí•œë‹¤ë©´, ì´í›„ì˜ ëª¨ë“  ìš”ì²­ë“¤ì€ ì˜ì›íˆ ë½ì„ ì–»ì§€ ëª»í•˜ê³  ëŒ€ê¸° ìƒíƒœì— ë¹ ì§€ê²Œ ëœë‹¤.

   ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ expire timeì„ ì¶”ê°€í•˜ë©´ ì¢‹ì€ë° SETNX ëª…ë ¹ì–´ì—ì„œëŠ” ì§€ì •í•  ìˆ˜ê°€ ì—†ì–´ í•´ê²°ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

2. Redisì— ì§€ì†ì ì¸ ìš”ì²­ìœ¼ë¡œ ë§ì€ íŠ¸ë˜í”½ì´ ë°œìƒí•œë‹¤.

   í•´ë‹¹ ë°©ì‹ì€ ìŠ¤í•€ ë½ ë°©ì‹ì´ë¼ lock ì„ íšë“í•˜ê¸° ìœ„í•´ Redis ì— ê³„ì†í•´ì„œ ìš”ì²­ì„ ë³´ë‚´ ë½ì„ íšë“í•˜ê¸° ìœ„í•´ ë§ì€ íŠ¸ë˜í”½ì´ ë°œìƒë˜ê³  ì´ëŠ” ì„±ëŠ¥ ì €í•˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.


## ë°©ë²•2. Redisonë¥¼ í†µí•œ Message Broker

ë‘ ë²ˆì§¸ ë°©ë²•ì€ [Redisson](https://github.com/redisson/redisson/)ì„ í†µí•´ Message Brokerë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì´ë‹¤. Redisonì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì€ ì•ì„œ ì‚´í´ë³¸ Lettuceë¥¼ í†µí•œ ë°©ì‹ì˜ ë¬¸ì œì ë“¤ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

- ë½ì„ íšë“í•˜ëŠ” íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬ ë½ì´ í•´ì œë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•´ì¤€ë‹¤.

    ```java
    public interface RLock extends Lock, RLockAsync {
        public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException
    }
    // ìš”ì²­ì„ í•˜ë©´ waitTimeë§Œí¼ ì‹œê°„ì´ ì§€ë‚˜ê²Œ ë˜ë©´ falseê°€ ë°˜í™˜ë˜ë©° ë½ íšë“ ì‹¤íŒ¨
    // ë½ì´ ê±¸ë¦¬ê³  leaseTimeë§Œí¼ì˜ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë½ì´ ë§Œë£Œë˜ì–´ ìŠ¤ìŠ¤ë¡œ í•´ì œ
    ```

- ìŠ¤í•€ë½ì´ ì•„ë‹Œ pub/sub ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ë©° ë ˆë””ìŠ¤ ì„œë²„ì˜ ë¶€í•˜ ë¬¸ì œë¥¼ í•´ê²°í•´ì¤€ë‹¤.

  Lock íšë“ì„ ì›í•˜ëŠ” Clientë“¤ì´ Redis ë¥¼ êµ¬ë…í•˜ê³  ìˆë‹¤ê°€ Redis ì—ì„œ Lock release ê°€ ë°œìƒí•˜ë©´ êµ¬ë…í•˜ê³  ìˆëŠ” Clientì—ê²Œ ì•Œë¦¼ì„ ì¤€ë‹¤. ì•Œë¦¼ì„ ë°›ì€ Client ë“¤ì€ ë‹¤ì‹œ lock íšë“ì„ ì‹œë„í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬ë™ëœë‹¤.


ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ê² ë‹¤.

### ì˜ì¡´ì„± ì¶”ê°€

```java
implementation 'org.redisson:redisson-spring-boot-starter:3.17.7'
```

**PartyService**

```java
@Service
//@Transactional íŠ¸ëœì­ì…˜ì„ ì œê±°
@RequiredArgsConstructor
public class PartyService {

    private final PartyRepository partyRepository;
    private final ParticipantRepository participantRepository;
    private final RedissonClient redissonClient;

    ...

    public ParticipantResponse participate(Long partyId, String name) {
        RLock lock = redissonClient.getLock(String.valueOf(partyId));
        try {
            if (!lock.tryLock(100, 2, TimeUnit.SECONDS)) {
                throw new RuntimeException("Lock íšë“ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
            }
            // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            Party party = partyRepository.findById(partyId).orElseThrow();
            if (party.isFull()) {
                throw new RuntimeException("ì •ì›ì´ ê°€ë“ ì°¨ìˆìŠµë‹ˆë‹¤.");
            }

            Participant participant = participantRepository.save(new Participant(name, party));
            return new ParticipantResponse(participant.getId(), participant.getName());
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } finally {
            lock.unlock();
        }
    }
}
```

ë¡œì§ì„ ì‚´í´ë³´ë©´ `reddissonClient.getLock()`ì„ í†µí•´ ë½ì— ëŒ€í•œ ì •ë³´ë¥¼ íšë“í•œ í›„  `lock.tryLock()`ì„ í†µí•´ ë½ì„ íšë“í•˜ê²Œ ëœë‹¤. í•´ë‹¹ ë¡œì§ì˜ ì¥ì ì€ ì•ì„œ ì´ì•¼ê¸°í–ˆë˜ ë°”ì™€ ê°™ì´ redis ì„œë²„ì— ë½ì— ëŒ€í•œ ì—¬ë¶€ë¥¼ ì§€ì†ì ìœ¼ë¡œ ë¬»ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ pub/subì˜ ê´€ê³„ë¡œ í•´ë‹¹ ë½ì— ëŒ€í•œ êµ¬ë…ì„ í•˜ë©°, redisì—ì„œ ë½ì´ í’€ë ¸ë‹¤ëŠ” ì•Œë¦¼ì„ ì¤¬ì„ ë•Œë§Œ ë½ì˜ íšë“ ìš”ì²­ì„ í•˜ê²Œ ëœë‹¤.

ê²°ê³¼ëŠ” Lettuceì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì˜¬ë°”ë¥¸ ê²°ê³¼ë¥¼ ë‚´ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Untitled](image/20230503-Redisë¥¼_í†µí•œ_ë¶„ì‚°ë½ìœ¼ë¡œ_ë™ì‹œì„±_ë¬¸ì œ_ì œì–´í•˜ê¸°/img_4.png)

### ğŸš¨Â ì£¼ì˜í•  ì  - Redisonì€ @Transactionalê³¼ í•¨ê»˜ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.

RedisëŠ” ëª…ë ¹ë“¤ì„ ì›ìì (Atomic)í•˜ê²Œ ì‹¤í–‰ë˜ë©° ì—¬ëŸ¬ ëª…ë ¹ì„ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ê³  ë‹¨ì¼ ì‘ì—… ë‹¨ìœ„ë¡œ ì‹¤í–‰í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.

ë”°ë¼ì„œ ìš°ë¦¬ê°€ í‰ìƒì‹œì— ì‚¬ìš©í•˜ëŠ” AOP ê¸°ë°˜ì˜ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ì¸ `@Transactional`ì€ ì‚¬ìš©í•  ìˆ˜ê°€ ì—†ë‹¤. ë§Œì•½ Redissonê³¼ íŠ¸ëœì­ì…˜ì„ í•¨ê»˜ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ë³„ë„ë¡œ TransactionManagerë¥¼ í†µí•´ ì§ì ‘ ì£¼ì…í•˜ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ì½”ë“œ ìì²´ì—ì„œ commit, rollback, start ë“±ì˜ ë¡œì§ì„ ìˆ˜í–‰í•´ì¤˜ì•¼ í•œë‹¤.

# ğŸ“šÂ Reference
- [ë ˆë””ìŠ¤ì™€ ë¶„ì‚° ë½(1/2) - ë ˆë””ìŠ¤ë¥¼ í™œìš©í•œ ë¶„ì‚° ë½ê³¼ ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë½ì˜ êµ¬í˜„](https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html)
- [[Redis] ë¶„ì‚°ë½(Distribution Lock) ì„ êµ¬í˜„í•´ ë‹¤ì¤‘í™” ì„œë²„ì—ì„œ ë°œìƒí•˜ëŠ” ë™ì‹œì„± ë¬¸ì œ ì œì–´í•˜ê¸°](https://velog.io/@msung99/Redis-ë¶„ì‚°-ë½ì„-êµ¬í˜„í•´-race-condition-ë™ì‹œì„±-ì´ìŠˆ-í•´ê²°í•˜ê¸°)
- [Redisë¡œ ë¶„ì‚° ë½ì„ êµ¬í˜„í•´ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•´ë³´ì!](https://hudi.blog/distributed-lock-with-redis/)
- [MySQLì„ ì´ìš©í•œ ë¶„ì‚°ë½ìœ¼ë¡œ ì—¬ëŸ¬ ì„œë²„ì— ê±¸ì¹œ ë™ì‹œì„± ê´€ë¦¬ | ìš°ì•„í•œí˜•ì œë“¤ ê¸°ìˆ ë¸”ë¡œê·¸](https://techblog.woowahan.com/2631/)
- [What is a Java distributed lock? | Redisson](https://redisson.org/glossary/java-distributed-lock.html)
- [6.2 Distributed locking | Redis](https://redis.com/ebook/part-2-core-concepts/chapter-6-application-components-in-redis/6-2-distributed-locking/)
- [[ê°œë°œììœ ì£¼ì œ 1í¸] ë°ì´í„° ë™ì‹œì„± ì ‘ê·¼ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ í•´ê²° ë°©ì•ˆ (DB lock, Redis)](https://insanelysimple.tistory.com/396)
- [Introduction to Lettuce - the Java Redis Client | Baeldung](http://baeldung.com/java-redis-lettuce)
- [redis ì„¤ì¹˜ ë° redissonì„ ì´ìš©í•œ ë¶„ì‚°ë½ êµ¬í˜„](https://it-hhhj2.tistory.com/102)
